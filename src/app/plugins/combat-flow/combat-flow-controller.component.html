<div class="container">
  <div class="tab-header">
    <button (click)="activeTab = 'combat'" [class.active]="activeTab === 'combat'">æˆ¦é—˜</button>
    <button (click)="activeTab = 'list'" [class.active]="activeTab === 'list'">æˆ¦æ³</button>
  </div>

  <div class="tab-content">
    <!-- =============================================== -->
    <!-- æˆ¦é—˜ã‚¿ãƒ–                                        -->
    <!-- =============================================== -->
    <div [hidden]="activeTab !== 'combat'">
      <!-- æˆ¦é—˜æ“ä½œUI (å¸¸ã«è¡¨ç¤º) -->
      <h4 class="title-with-help">æˆ¦é—˜æ“ä½œ <button class="help-button-mini" (click)="openHelp($event)" title="æ“ä½œãƒ˜ãƒ«ãƒ—">?</button></h4>
      
      <!-- è¡Œå‹•å®£è¨€ã‚¨ãƒªã‚¢ (ä»®) -->
      <div class="action-declaration">
        <span class="actor" 
              (mouseenter)="highlightCaster = true" 
              (mouseleave)="highlightCaster = false"
              style="cursor: pointer;">{{ getCharacterName(selectedCasterId) || '[èª°ãŒ]' }}</span> ã¯
        <span class="target"
              (mouseenter)="highlightTarget = true" 
              (mouseleave)="highlightTarget = false"
              style="cursor: pointer;">{{ getTargetNames(selectedTargetIds) }}</span> 
        <ng-container *ngIf="operationMode === 'parameter'">
          ã® <span class="effect"
                   (mouseenter)="highlightAction = true" 
                   (mouseleave)="highlightAction = false"
                   style="cursor: pointer;">{{ selectedParameterDisplayName || '[ä½•]' }}</span> ã‚’ <span class="value" (mouseenter)="highlightValue = true" (mouseleave)="highlightValue = false" style="cursor: pointer;">{{ parameterValue }}</span> ã™ã‚‹
        </ng-container>
        <ng-container *ngIf="operationMode === 'statusEffect'">
          ã« <span class="effect"
                   (mouseenter)="highlightAction = true" 
                   (mouseleave)="highlightAction = false"
                   style="cursor: pointer;">{{ selectedStatusEffectName || '[åŠ¹æœ]' }}</span> ã‚’ä»˜ä¸ã™ã‚‹
        </ng-container>
      </div>

      <!-- è¡“è€…é¸æŠã¨å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
      <div class="action-execute-container" [ngClass]="{'highlight-form': highlightCaster}">
        <label>è¡“è€…:</label>
        <select [(ngModel)]="selectedCasterId" (ngModelChange)="onCasterChange()" class="param-input caster-select">
          <option [ngValue]="null">é¸æŠã—ã¦ãã ã•ã„</option>
          <option *ngFor="let combatant of (activeCasterCandidates$ | async)" [ngValue]="combatant.characterId">
            {{ combatant.name }}
          </option>
        </select>
        <button class="primary execute-button" 
          (click)="operationMode === 'parameter' ? applyParameterChange() : applyStatusEffect()" 
          [disabled]="!selectedCasterId || selectedTargetIds.size === 0 || (operationMode === 'parameter' && (!selectedParameterName || parameterValue === 0)) || (operationMode === 'statusEffect' && !selectedStatusEffectId)">
          å®Ÿè¡Œ
        </button>
      </div>

      <div class="selection-container">
        <!-- å·¦ã‚«ãƒ©ãƒ : å¯¾è±¡é¸æŠãƒªã‚¹ãƒˆ -->
        <div class="list-column" [ngClass]="{'highlight-form': highlightTarget}">
          <h4 class="title-with-button">å¯¾è±¡é¸æŠã€€<small>è¤‡æ•°é¸æŠå¯èƒ½</small>
            <button class="icon-button-dark" title="ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‹ã‚‰å¯¾è±¡ã‚’è‡ªå‹•é¸æŠ" (click)="onTargetSelectButtonClick()">ğŸ²</button>
          </h4>
          <div class="character-list-container combatant-list">
            <div *ngFor="let combatant of (activeCasterCandidates$ | async)" 
                 class="character-item" 
                 [class.selected]="selectedTargetIds.has(combatant.characterId)"
                 (click)="toggleTarget(combatant.characterId)">
              {{ combatant.name }}
            </div>
          </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ : æ“ä½œãƒ‘ãƒãƒ« (ã‚¿ãƒ–) -->
        <div class="list-column" [ngClass]="{'highlight-form': highlightAction}">
          <div class="sub-tab-header">
            <button (click)="operationMode = 'parameter'" [class.active]="operationMode === 'parameter'">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</button>
            <button (click)="operationMode = 'statusEffect'" [class.active]="operationMode === 'statusEffect'">åŠ¹æœ</button>
          </div>
          <div class="sub-tab-content">
            <!-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ -->
            <ng-container *ngIf="operationMode === 'parameter'">
              <!-- <h4>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é¸æŠ</h4> -->
              <div class="parameter-list-container">
                <div *ngIf="selectedTargetIds.size === 0" class="list-placeholder">å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
                <div *ngIf="selectedTargetIds.size > 0 && availableParameters.length === 0" class="list-placeholder">å…±é€šã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                <div *ngFor="let param of availableParameters" 
                     class="character-item"
                     [class.selected]="selectedParameterName === param.key"
                     (click)="selectedParameterName = param.key">
                  {{ param.name }}
                </div>
              </div>
            </ng-container>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ‰ -->
            <ng-container *ngIf="operationMode === 'statusEffect'">
              <!-- <h4>åŠ¹æœé¸æŠ</h4> -->
              <div class="status-effect-list-container character-list-container">
                <div *ngIf="statusEffectTemplates.length === 0" class="list-placeholder">
                  ç™»éŒ²æ¸ˆã¿ã®åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ç®¡ç†ã‚¿ãƒ–ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
                </div>
                <div *ngFor="let effect of statusEffectTemplates" 
                     class="character-item"
                     [class.selected]="selectedStatusEffectId === effect.id"
                     (click)="selectedStatusEffectId = effect.id">
                  <span class="status-icon-preview">
                    <span *ngIf="effect.emoji">{{ effect.emoji }}</span>
                  </span>
                  <span>{{ effect.name }}</span>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- å¤‰åŒ–é‡å…¥åŠ› (ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºã€ã‚¿ãƒ–ã®å¤–) -->
      <div *ngIf="operationMode === 'parameter'" class="parameter-input-container" [ngClass]="{'highlight-form': highlightValue}">
        <h4 class="title-with-button">å¤‰åŒ–é‡
          <button class="icon-button-dark" title="æ­£è² ã‚’åè»¢" (click)="toggleParameterSign()"><span class="pm-icon">Â±</span></button>
          <button class="icon-button-dark" title="æœ€æ–°ã®ãƒ€ã‚¤ã‚¹çµæœã‚’ã‚³ãƒ”ãƒ¼" (click)="onDiceCopyButtonClick()">ğŸ²</button>
        </h4>
        <input type="number" [(ngModel)]="parameterValue" class="param-input parameter-value-input">
      </div>

      <!-- ä¸‹éƒ¨ã‚³ãƒ³ãƒ†ãƒŠ (ä»˜ä¸æ¸ˆã¿åŠ¹æœãƒªã‚¹ãƒˆãªã©) -->
      <div class="bottom-container">
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ‰ ã‹ã¤ å¯¾è±¡ãŒ1ä½“ã®å ´åˆã®ã¿è¡¨ç¤º -->
        <div *ngIf="operationMode === 'statusEffect' && singleSelectedTargetId" class="applied-effects-container">
          <h5 class="applied-effects-title">{{ getCharacterName(singleSelectedTargetId) }} ã®åŠ¹æœ (å·¦ã‚¯ãƒªãƒƒã‚¯:æ¸›å°‘/è§£é™¤, å³ã‚¯ãƒªãƒƒã‚¯:å¢—åŠ )</h5>
          <div *ngIf="getActiveStatusEffects(singleSelectedTargetId).length === 0" class="list-placeholder">ä»˜ä¸ã•ã‚Œã¦ã„ã‚‹åŠ¹æœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
          <div class="applied-effect-list">
            <div *ngFor="let effect of getActiveStatusEffects(singleSelectedTargetId)" 
                 class="applied-effect-item" 
                 (click)="onAppliedEffectClick(effect)" 
                 (contextmenu)="onAppliedEffectRightClick($event, effect)"
                 title="å·¦ã‚¯ãƒªãƒƒã‚¯: æ®‹ã‚Šãƒ©ã‚¦ãƒ³ãƒ‰æ¸›å°‘/è§£é™¤, å³ã‚¯ãƒªãƒƒã‚¯: å¢—åŠ ">
              <!-- çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ -->
              <span *ngIf="effect.emoji" class="effect-icon emoji-native">{{ effect.emoji }}</span>
              <!-- Material Icon (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) -->
              <i *ngIf="!effect.emoji" class="material-icons effect-icon">star</i>
              <span class="effect-name">{{ effect.name }}</span>
              <span *ngIf="!effect.isPermanent" class="effect-duration">({{ effect.remainingRounds }}R)</span>
              <span *ngIf="effect.isPermanent" class="effect-duration">(æ°¸é )</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top: 1em;"></div> <!-- Spacer -->
    </div>

    <!-- =============================================== -->
    <!-- æˆ¦æ³ã‚¿ãƒ–                                      -->
    <!-- =============================================== -->
    <div [hidden]="activeTab !== 'list'">
      <!-- æ‰‹ç•ªãƒ»æˆ¦é—˜ç®¡ç† -->
      <h4>æ‰‹ç•ªãƒ»æˆ¦é—˜æ“ä½œ</h4>
      <div class="turn-controls-container">
        <div class="turn-controls">
          <button (click)="prevTurn()" [disabled]="!(isCombat$ | async)">ï¼œ æˆ»ã‚‹</button>
          <button (click)="nextTurn()" [disabled]="!(isCombat$ | async)">æ¬¡ã¸ ï¼</button>
          <button (click)="nextRound()">æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰</button>
          <span class="round-display" (click)="resetRound()" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’1ã«ãƒªã‚»ãƒƒãƒˆ">
            R{{ ((isCombat$ | async) ? (round$ | async) : (preCombatRound$ | async)) | number:'2.0-0' }}
          </span>
        </div>
        <button *ngIf="isCombat$ | async" class="danger" (click)="endCombat()">æˆ¦é—˜çµ‚äº†</button>
        <button *ngIf="!(isCombat$ | async)" class="primary" (click)="startCombat()" [disabled]="(selectedCharacterCount$ | async) === 0">æˆ¦é—˜é–‹å§‹</button>
      </div>
      <hr>

      <!-- çµ±åˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ -->
      <h4 class="title-with-button">
        <span>æˆ¦é—˜å‚åŠ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ <small>ãƒã‚§ãƒƒã‚¯ONã§å‚åŠ /OFFã§å¾…æ©Ÿ</small></span>
        <label *ngIf="!(isCombat$ | async)" class="checkbox-label" title="å…¨å“¡é¸æŠ/è§£é™¤" style="margin-left: auto; margin-right: 0;">
          <input type="checkbox" 
                 [checked]="isAllSelected$ | async" 
                 (change)="toggleAllCharacters()">
          <span style="font-size: 0.8em; margin-left: 4px;">å…¨é¸æŠ</span>
        </label>
      </h4>
      
      <div class="character-list-container unified-list">
        <div *ngFor="let item of (unifiedParticipantList$ | async)"
             [ngClass]="{
               'list-separator': item.type === 'separator',
               'character-item': item.type !== 'separator',
               'selected': item.type !== 'separator' && (selectedParticipantIdForReorder$ | async) === item.characterId,
               'participating': item.isParticipating,
               'standby': !item.isParticipating
             }"
             (click)="item.type !== 'separator' && selectParticipantForReorder(item.characterId)">
          
          <!-- ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ -->
          <ng-container *ngIf="item.type === 'separator'">
            <span>--- å¾…æ©Ÿä¸­ ---</span>
          </ng-container>

          <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ -->
          <ng-container *ngIf="item.type !== 'separator'">
            <label class="checkbox-label" (click)="$event.stopPropagation()">
              <input type="checkbox" 
                     [checked]="item.isParticipating" 
                     (click)="toggleParticipantStatus(item, $event)">
            </label>
            <span class="character-name">{{ item.name }}</span>
          </ng-container>
        </div>
      </div>
      
      <div class="order-controls">
        <button (click)="moveParticipantUp()" [disabled]="!(selectedParticipantIdForReorder$ | async)">â–² ä¸Šã¸</button>
        <button (click)="moveParticipantDown()" [disabled]="!(selectedParticipantIdForReorder$ | async)">â–¼ ä¸‹ã¸</button>
      </div>
    </div>
  </div>

  <div class="footer-controls">
    <button class="icon-button settings-button" (click)="openSettings()" title="è¨­å®š"><i class="material-icons">settings</i></button>
  </div>
</div>