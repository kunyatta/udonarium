<div class="panel-layout">
  <div class="udonarium-tab-container">
    <div class="udonarium-tab-header">
      <div class="tab-item" [class.active]="activeTab === 'settings'" (click)="activeTab = 'settings'">
        設定
      </div>
      <div class="tab-item" [class.active]="activeTab === 'status-effects'" (click)="activeTab = 'status-effects'">
        ステータス効果管理
      </div>
    </div>

    <div class="udonarium-tab-content" style="padding: 0;">
      
      <!-- =============================================== -->
      <!-- 設定タブ                                        -->
      <!-- =============================================== -->
      <div *ngIf="activeTab === 'settings'" class="settings-panel panel-body">
        
        <div class="info-card">
          <h4>表示パラメータ設定</h4>
          <p>戦闘パネルのカードに表示するパラメータ（例: HP MP 敏捷度）</p>
          <input type="text" class="udonarium-input" [ngModel]="displayDataTags" (ngModelChange)="onDisplayDataTagsChange($event)" placeholder="例: HP MP 敏捷度">
        </div>

        <div class="info-card">
          <h4>チャット設定</h4>
          <div class="form-group">
            <label>ログ出力先タブ</label>
            <select [(ngModel)]="messageTargetTabId" (ngModelChange)="onMessageTargetTabChange($event)" class="udonarium-select">
              <option *ngFor="let tab of availableChatTabs" [value]="tab.identifier">{{ tab.name }}</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label>システムログ送信元</label>
            <select [(ngModel)]="selectedLogSenderName" (ngModelChange)="onSystemLogSenderNameChange($event)" class="udonarium-select">
              <option value="">指定なし（操作者）</option>
              <option *ngFor="let char of (availableLogSenders$ | async)" [value]="char.name">{{ char.name }}</option>
            </select>
          </div>
        </div>

        <div class="info-card">
          <h4>パネル・操作</h4>
          <div style="display: flex; gap: var(--spacing-s);">
            <button class="udonarium-btn" style="flex: 1" (click)="toggleCombatPanel()">戦闘パネル 表示/非表示</button>
          </div>
        </div>

        <div class="info-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-s); border-bottom: 1px solid var(--border-color); padding-bottom: var(--spacing-xs);">
            <h4 style="margin: 0; border: none; padding: 0;">ダメージ適用確認設定</h4>
            <label class="checkbox-label" style="font-size: 0.85em;">
              <input type="checkbox" [(ngModel)]="damageCheckConfig.showDamageCheckPanel" (change)="saveDamageCheckConfig()"> 有効にする
            </label>
          </div>

          <div class="form-group" [style.opacity]="damageCheckConfig.showDamageCheckPanel ? 1 : 0.5">
            <label>軽減参照パラメータ <small>(防護点、抵抗力などスペース区切り)</small></label>
            <input type="text" class="udonarium-input" [(ngModel)]="damageCheckConfig.referenceParams" (change)="saveDamageCheckConfig()" [disabled]="!damageCheckConfig.showDamageCheckPanel" placeholder="例: 防護点">
          </div>

          <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px; color: var(--text-color-secondary);">表示ボタン</div>
          <div class="checkbox-grid" [style.opacity]="damageCheckConfig.showDamageCheckPanel ? 1 : 0.5">
            <label class="checkbox-label"><input type="checkbox" [disabled]="!damageCheckConfig.showDamageCheckPanel" [checked]="damageCheckConfig.buttonConfig.showAsIs" (change)="toggleDamageCheckButton('showAsIs')"> そのまま</label>
            <label class="checkbox-label"><input type="checkbox" [disabled]="!damageCheckConfig.showDamageCheckPanel" [checked]="damageCheckConfig.buttonConfig.showReduce" (change)="toggleDamageCheckButton('showReduce')"> 軽減</label>
            <label class="checkbox-label"><input type="checkbox" [disabled]="!damageCheckConfig.showDamageCheckPanel" [checked]="damageCheckConfig.buttonConfig.showHalve" (change)="toggleDamageCheckButton('showHalve')"> 半減</label>
            <label class="checkbox-label"><input type="checkbox" [disabled]="!damageCheckConfig.showDamageCheckPanel" [checked]="damageCheckConfig.buttonConfig.showZero" (change)="toggleDamageCheckButton('showZero')"> 無効</label>
            <label class="checkbox-label"><input type="checkbox" [disabled]="!damageCheckConfig.showDamageCheckPanel" [checked]="damageCheckConfig.buttonConfig.showCustom" (change)="toggleDamageCheckButton('showCustom')"> カスタム入力</label>
          </div>
        </div>

      </div>

      <!-- =============================================== -->
      <!-- ステータス効果管理タブ (2カラム)                -->
      <!-- =============================================== -->
      <div *ngIf="activeTab === 'status-effects'" class="layout-2pane">
        
        <!-- 左カラム: サイドバー (リスト) -->
        <div class="layout-sidebar">
          <div class="panel-header">
            <button class="udonarium-btn primary" style="width: 100%" (click)="createNewEffect()">+ 新規作成</button>
          </div>
          <div class="panel-body" style="padding: 0; overflow-x: hidden; gap: 0;">
            <button *ngFor="let effect of statusEffectTemplates; let i = index"
                 class="list-item"
                 [class.active]="selectedEffectIndex === i"
                 (click)="selectEffect(i)">
              <span class="list-icon">{{ effect.emoji }}</span>{{ effect.name }}
            </button>
          </div>
          <div class="panel-footer" style="flex-direction: column; gap: 4px;">
            <button class="udonarium-btn" style="width: 100%" (click)="exportStatusEffectDictionaryAsZip()">まとめて保存</button>
            <button *ngIf="!isProduction" class="udonarium-btn" style="width: 100%; font-size: 10px;" (click)="exportStatusEffectDictionaryAsXml()">開発用XML出力</button>
          </div>
        </div>

        <!-- 右カラム: メイン (エディタ) -->
        <div class="layout-main">
          <!-- エディタヘッダー -->
          <div class="panel-header" *ngIf="editingEffect" style="justify-content: space-between;">
            <div style="font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              効果: {{ editingEffect.name }}
            </div>
            <div style="display: flex; gap: var(--spacing-s);">
              <button class="udonarium-btn primary" (click)="saveEffect()">反映</button>
              <button class="udonarium-btn" (click)="exportSingleEffectAsZip()">保存</button>
              <button class="udonarium-btn danger" (click)="deleteEffect()" [disabled]="selectedEffectIndex < 0">削除</button>
            </div>
          </div>

          <!-- エディタ本体 -->
          <div class="panel-body" *ngIf="editingEffect">
            
            <div class="info-card">
              <div style="font-weight: bold; margin-bottom: var(--spacing-s); font-size: 12px; color: var(--text-color-secondary);">基本情報</div>
              
              <div class="flex-row">
                <div class="flex-label">名前</div>
                <input type="text" class="udonarium-input" [(ngModel)]="editingEffect.name" placeholder="例: 毒">
              </div>

              <div class="flex-row">
                <div class="flex-label">絵文字</div>
                <div class="flex-controls">
                  <input type="text" class="udonarium-input" style="width: 60px;" [(ngModel)]="editingEffect.emoji" placeholder="☠️" maxlength="2">
                  <span class="list-icon" style="margin-left: 8px; font-size: 1.5em;">{{ editingEffect.emoji }}</span>
                </div>
              </div>
          
              <div class="flex-row">
                <div class="flex-label">持続R</div>
                <div class="flex-controls">
                  <input type="number" class="udonarium-input" style="width: 60px;" [(ngModel)]="editingEffect.duration" [disabled]="editingEffect.isPermanent">
                  <label class="checkbox-label" style="font-size: 12px; margin-left: 8px;">
                    <input type="checkbox" [(ngModel)]="editingEffect.isPermanent"> 永遠
                  </label>
                </div>
              </div>

              <div class="flex-row" style="align-items: flex-start;">
                <div class="flex-label" style="margin-top: 6px;">説明</div>
                <textarea class="udonarium-textarea" rows="2" [(ngModel)]="editingEffect.description" placeholder="ツールチップで表示される説明文"></textarea>
              </div>
            </div>

            <div class="info-card">
              <div style="font-weight: bold; font-size: 12px; color: var(--text-color-secondary); margin-bottom: var(--spacing-s);">視覚効果</div>
              
              <div class="flex-row">
                <div class="flex-label">フィルター</div>
                <div class="checkbox-grid">
                  <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.filters.inverse"> 反転</label>
                  <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.filters.hollow"> ぼかし</label>
                  <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.filters.blackPaint"> 黒塗り</label>
                  <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.filters.grayscale"> グレー</label>
                </div>
              </div>

              <div class="flex-row">
                <div class="flex-label">カラー</div>
                <div class="color-effects-row">
                  <div class="color-control">
                    <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.aura.enabled"> オーラ</label>
                    <input type="color" [(ngModel)]="uiModel.aura.color" [disabled]="!uiModel.aura.enabled" style="width: 30px; height: 24px; padding: 0; border: none;">
                  </div>
                  <div class="color-control">
                    <label class="checkbox-label"><input type="checkbox" [(ngModel)]="uiModel.backgroundColor.enabled"> 背景色</label>
                    <input type="color" [(ngModel)]="uiModel.backgroundColor.color" [disabled]="!uiModel.backgroundColor.enabled" style="width: 30px; height: 24px; padding: 0; border: none;">
                  </div>
                </div>
              </div>
            </div>

            <div class="info-card">
              <div style="font-weight: bold; font-size: 12px; color: var(--text-color-secondary); margin-bottom: var(--spacing-s);">機械的な効果</div>
              
              <div class="flex-row">
                <div class="flex-label">種類</div>
                <div class="radio-group">
                  <label class="radio-label" style="font-size: 12px;">
                    <input type="radio" name="effectType" [(ngModel)]="uiModel.effectType" value="attributeChange"> ラウンド毎
                  </label>
                  <label class="radio-label" style="font-size: 12px;">
                    <input type="radio" name="effectType" [(ngModel)]="uiModel.effectType" value="buffDebuff"> バフ/デバフ
                  </label>
                </div>
              </div>

              <div class="flex-row">
                <div class="form-label-container">
                  <div style="font-size: 11px; color: var(--text-color-secondary);">対象</div>
                  <label class="checkbox-label" style="font-size: 10px; font-weight: normal;">
                    <input type="checkbox" [checked]="!showAllParameters" (change)="toggleShowAllParameters()"> 共通のみ
                  </label>
                </div>
                <select class="udonarium-select" [(ngModel)]="uiModel.targetParam" style="flex: 1;">
                  <option value="" disabled>選択...</option>
                  <option *ngFor="let param of availableParameters" [value]="param.key">{{ param.name }}</option>
                </select>
              </div>
              
              <div class="flex-row">
                <div class="flex-label">変化量</div>
                <input type="number" class="udonarium-input" style="width: 80px;" [(ngModel)]="uiModel.value" placeholder="0">
              </div>
            </div>

            <div style="margin-top: var(--spacing-m); font-size: 11px; color: var(--text-color-secondary); text-align: center;">
              ※ 反映ボタンを押すと変更が確定されます。
            </div>
          </div>

          <!-- 空の状態 -->
          <div class="empty-state" *ngIf="!editingEffect">
            <i class="material-icons empty-state-icon">auto_fix_high</i>
            <div class="empty-state-message">効果を選択するか、新規作成してください</div>
            <div class="empty-state-description">
              戦闘中にキャラクターへ付与できる、毒や麻痺などの状態異常を管理します
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
