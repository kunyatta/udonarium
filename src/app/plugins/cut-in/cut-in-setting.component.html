<div class="panel-layout">
  <div class="layout-2pane">
    <!-- 左ペイン: リスト -->
    <div class="layout-sidebar">
      <div class="panel-header">
        <button class="udonarium-btn primary" style="width: 100%;  font-size: 13px;" (click)="createNew()">＋ 新規カットイン</button>
      </div>
      <div class="panel-body" style="padding: 0; overflow-x: hidden;">
        <button *ngFor="let item of cutIns" 
                class="list-item"
                [class.active]="selectedIdentifier === item.identifier"
                (click)="select(item.identifier)">
          {{ item.name || '(名称未設定)' }}
        </button>
        <div *ngIf="cutIns.length === 0" style="padding: var(--spacing-m); text-align: center; color: var(--text-color-secondary); font-size: 12px;">
          データがありません
        </div>
      </div>
      <div class="panel-footer">
        <button class="udonarium-btn" style="width: 100%" (click)="exportAll()">まとめて保存</button>
      </div>
    </div>

    <!-- 右ペイン: エディタ -->
    <div class="layout-main">
      <ng-container *ngIf="editingCutIn; else noSelection">
        <!-- 固定ヘッダー: 名前と再生コントロール -->
        <div class="panel-header" style="justify-content: space-between;">
          <div style="font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            {{ editingCutIn.name }}
          </div>
          <div style="display: flex; gap: 2px;">
            <button class="udonarium-btn" style="padding: 2px 6px;" (click)="play()" title="全体に再生">▶ 再生</button>
            <button class="udonarium-btn" style="padding: 2px 6px;" (click)="playLocal()" title="自分だけ見る">👁</button>
            <button class="udonarium-btn danger" style="padding: 2px 6px;" (click)="stopAll()" title="演出を停止（全員）">■ 停止</button>
          </div>
        </div>

        <!-- 固定操作エリア: ソース選択、プレビュー、基本操作 -->
        <div style="padding: var(--spacing-m); border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: transparent;">
          <!-- 1. ソース選択 (前提条件) -->
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: var(--spacing-s); font-size: 13px;">
            <span style="font-weight: bold; color: var(--text-color-secondary);">ソース:</span>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="radio" name="cutInType" value="image" [(ngModel)]="cutInType"> 画像
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
              <input type="radio" name="cutInType" value="video" [(ngModel)]="cutInType"> 動画
            </label>
          </div>

          <!-- 2. プレビュー (HUD) -->
          <div class="hud-style preview-container" (click)="cutInType === 'image' ? openImageSelecter() : null" [title]="cutInType === 'image' ? '画像を変更' : ''">
            <ng-container *ngIf="cutInType === 'image'">
              <img [src]="getImageUrl(editingCutIn.imageIdentifier)" *ngIf="editingCutIn.imageIdentifier">
              <div class="preview-placeholder" *ngIf="!editingCutIn.imageIdentifier">クリックして画像を選択</div>
            </ng-container>
            <ng-container *ngIf="cutInType === 'video'">
              <img [src]="getVideoThumbnailUrl()" *ngIf="editingCutIn.videoIdentifier">
              <div class="preview-placeholder" *ngIf="!editingCutIn.videoIdentifier">URLを入力してください</div>
            </ng-container>
          </div>

          <!-- 3. 基本操作ボタン -->
          <div style="display: flex; gap: var(--spacing-s); margin-top: var(--spacing-s);">
            <button class="udonarium-btn" (click)="export()">保存</button>
            <button class="udonarium-btn danger" (click)="delete()">削除</button>
          </div>
        </div>

        <!-- スクロールエリア: 詳細設定 -->
        <div class="panel-body">
          <div class="info-card">
            <div style="font-weight: bold; margin-bottom: var(--spacing-s); font-size: 12px; color: var(--text-color-secondary);">基本設定</div>
            
            <div class="flex-row" *ngIf="cutInType === 'video'">
              <div class="flex-label">YouTube ID</div>
              <input type="text" class="udonarium-input" [(ngModel)]="videoUrl" placeholder="URLまたは動画IDを入力">
            </div>

            <div class="flex-row">
              <div class="flex-label">名称</div>
              <input type="text" class="udonarium-input" [(ngModel)]="editingCutIn.name" (change)="update()">
            </div>

            <div class="flex-row">
              <div class="flex-label">キーワード</div>
              <input type="text" class="udonarium-input" [(ngModel)]="editingCutIn.keyword" (change)="update()" placeholder="@必殺技 など">
            </div>

            <div class="flex-row">
              <div class="flex-label">表示秒数</div>
              <div class="flex-controls">
                <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.duration" (change)="update()" min="0">
                <span class="unit-text">秒 {{ editingCutIn.type === 'video' ? '(0=動画終了まで)' : '(0=無制限)' }}</span>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div style="font-weight: bold; margin-bottom: var(--spacing-s); font-size: 12px; color: var(--text-color-secondary);">音響設定</div>
            <div class="flex-row">
              <div class="flex-label">音源</div>
              <select class="udonarium-select" [(ngModel)]="editingCutIn.audioIdentifier" (change)="update()">
                <option value="">(なし)</option>
                <option *ngFor="let audio of audios" [value]="audio.identifier">{{ audio.name }}</option>
              </select>
            </div>
            
            <ng-container *ngIf="editingCutIn.audioIdentifier">
              <div class="flex-row">
                <div class="flex-label">再生モード</div>
                <div class="flex-controls">
                  <input type="radio" id="audioModeSE" name="audioMode" value="se" [(ngModel)]="editingCutIn.audioMode" (change)="update()">
                  <label for="audioModeSE" style="margin-right: 12px">SE</label>
                  <input type="radio" id="audioModeBGM" name="audioMode" value="bgm" [(ngModel)]="editingCutIn.audioMode" (change)="update()">
                  <label for="audioModeBGM">BGM</label>
                </div>
              </div>
              <div class="flex-row">
                <div class="flex-label"></div>
                <div class="flex-controls" style="font-size: 12px">
                  <label *ngIf="editingCutIn.audioMode === 'se'" style="margin-right: 12px">
                    <input type="checkbox" [(ngModel)]="editingCutIn.isLoop" (change)="update()"> ループ
                  </label>
                  <label>
                    <input type="checkbox" [(ngModel)]="editingCutIn.stopJukebox" (change)="update()"> 既存BGMを停止
                  </label>
                </div>
              </div>

              <!-- 終了後BGM設定 (復元) -->
              <ng-container *ngIf="editingCutIn.stopJukebox">
                <div class="flex-row">
                  <div class="flex-label">終了後BGM</div>
                  <select class="udonarium-select" [(ngModel)]="editingCutIn.afterAudioIdentifier" (change)="update()">
                    <option value="">(なし / 停止したまま)</option>
                    <option *ngFor="let audio of audios" [value]="audio.identifier">{{ audio.name }}</option>
                  </select>
                </div>
                <div class="flex-row" *ngIf="editingCutIn.afterAudioIdentifier">
                  <div class="flex-label">待機時間</div>
                  <div class="flex-controls">
                    <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.afterAudioDelay" (change)="update()" min="0" step="0.5">
                    <span class="unit-text">秒後</span>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </div>

          <div class="info-card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-s);">
              <div style="font-weight: bold; font-size: 12px; color: var(--text-color-secondary);">配置・サイズ</div>
              <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; color: var(--text-color-secondary);">
                <input type="checkbox" [(ngModel)]="showGuide" (change)="onGuideToggle()"> 配置ガイドを表示
              </label>
            </div>
            
            <div class="flex-row">
              <div class="flex-label">サイズ指定</div>
              <div class="flex-controls">
                <input type="radio" id="modeScale" name="sizeMode" value="scale" [(ngModel)]="sizeMode">
                <label for="modeScale" style="margin-right: 12px">拡大率</label>
                <input type="radio" id="modeRatio" name="sizeMode" value="ratio" [(ngModel)]="sizeMode">
                <label for="modeRatio">画面比率</label>
              </div>
            </div>

            <div class="flex-row" *ngIf="sizeMode === 'scale'">
              <div class="flex-label">拡大率</div>
              <div class="flex-controls">
                <input type="range" style="flex: 1" min="0.1" max="3.0" step="0.1" [(ngModel)]="editingCutIn.scale" (input)="update()">
                <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.scale" (change)="update()" min="0.1" step="0.1">
                <span class="unit-text">倍</span>
              </div>
            </div>

            <div class="flex-row" *ngIf="sizeMode === 'ratio'">
              <div class="flex-label">幅</div>
              <div class="flex-controls">
                <input type="range" style="flex: 1" min="1" max="100" step="1" [(ngModel)]="editingCutIn.width" (input)="update()">
                <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.width" (change)="update()" min="1" max="100">
                <span class="unit-text">%</span>
              </div>
            </div>

            <div class="flex-row">
              <div class="flex-label">位置 X</div>
              <div class="flex-controls">
                <input type="range" style="flex: 1" min="0" max="100" step="1" [(ngModel)]="editingCutIn.left" (input)="update()">
                <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.left" (change)="update()" min="0" max="100">
                <span class="unit-text">%</span>
              </div>
            </div>

            <div class="flex-row">
              <div class="flex-label">位置 Y</div>
              <div class="flex-controls">
                <input type="range" style="flex: 1" min="0" max="100" step="1" [(ngModel)]="editingCutIn.top" (input)="update()">
                <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.top" (change)="update()" min="0" max="100">
                <span class="unit-text">%</span>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-s); margin-bottom: var(--spacing-s);">
              <input type="checkbox" id="useInEffect" [(ngModel)]="editingCutIn.useInEffect" (change)="update()">
              <label for="useInEffect" style="font-weight: bold; font-size: 12px; color: var(--text-color-secondary); cursor: pointer;">登場演出を使用する</label>
            </div>
            
            <div [style.opacity]="editingCutIn.useInEffect ? 1 : 0.4" [style.pointer-events]="editingCutIn.useInEffect ? 'auto' : 'none'">
              <div class="quick-btns">
                <button class="udonarium-btn" [class.active]="activeInEffect === 'fade'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('fade')">フェード</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'slide-left'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('slide-left')">←スライド</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'slide-right'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('slide-right')">スライド→</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'slide-up'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('slide-up')">↑スライド</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'slide-down'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('slide-down')">↓スライド</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'zoom-in'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('zoom-in')">ズームイン</button>
                <button class="udonarium-btn" [class.active]="activeInEffect === 'zoom-out'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickInEffect('zoom-out')">ズームアウト</button>
              </div>
              
              <div class="advanced-settings">
                <details>
                  <summary [class.is-custom]="editingCutIn.useInEffect && !activeInEffect">詳細設定（時間・イージング・開始位置・状態）</summary>
                  
                  <div style="margin: var(--spacing-s) 0; display: flex; justify-content: flex-end;">
                    <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; color: var(--text-color-secondary);">
                      <input type="checkbox" [(ngModel)]="showInGuide" (change)="onInGuideToggle()"> 開始位置ガイドを表示 (緑)
                    </label>
                  </div>

                  <div class="flex-row">
                    <div class="flex-label">時間(ms)</div>
                    <div class="flex-controls">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.inDuration" (change)="onInDetailChange()" step="100" min="0">
                      <select class="udonarium-select" [(ngModel)]="editingCutIn.easing" (change)="onInDetailChange()">
                        <option *ngFor="let e of easings" [value]="e">{{e}}</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">位置 X</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="-100" max="200" step="1" [(ngModel)]="editingCutIn.startLeft" (input)="onInDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.startLeft" (change)="onInDetailChange()">
                      <span class="unit-text">%</span>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">位置 Y</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="-100" max="200" step="1" [(ngModel)]="editingCutIn.startTop" (input)="onInDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.startTop" (change)="onInDetailChange()">
                      <span class="unit-text">%</span>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">不透明度</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="0" max="1" step="0.1" [(ngModel)]="editingCutIn.startOpacity" (input)="onInDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.startOpacity" (change)="onInDetailChange()" step="0.1" min="0" max="1">
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">拡大率</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="0.1" max="3.0" step="0.1" [(ngModel)]="editingCutIn.startScale" (input)="onInDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.startScale" (change)="onInDetailChange()" step="0.1" min="0.1" max="3.0">
                      <span class="unit-text">倍</span>
                    </div>
                  </div>
                </details>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-s); margin-bottom: var(--spacing-s);">
              <input type="checkbox" id="useOutEffect" [(ngModel)]="editingCutIn.useOutEffect" (change)="update()">
              <label for="useOutEffect" style="font-weight: bold; font-size: 12px; color: var(--text-color-secondary); cursor: pointer;">退場演出を使用する</label>
            </div>

            <div [style.opacity]="editingCutIn.useOutEffect ? 1 : 0.4" [style.pointer-events]="editingCutIn.useOutEffect ? 'auto' : 'none'">
              <div class="quick-btns">
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'fade'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('fade')">フェード</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'slide-left'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('slide-left')">←スライド</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'slide-right'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('slide-right')">スライド→</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'slide-up'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('slide-up')">↑スライド</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'slide-down'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('slide-down')">↓スライド</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'zoom-in'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('zoom-in')">ズームイン</button>
                <button class="udonarium-btn" [class.active]="activeOutEffect === 'zoom-out'" style="padding: 2px 6px; font-size: 11px;" (click)="setQuickOutEffect('zoom-out')">ズームアウト</button>
              </div>

              <div class="advanced-settings">
                <details>
                  <summary [class.is-custom]="editingCutIn.useOutEffect && !activeOutEffect">詳細設定（時間・イージング・終了位置・状態）</summary>
                  
                  <div style="margin: var(--spacing-s) 0; display: flex; justify-content: flex-end;">
                    <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; color: var(--text-color-secondary);">
                      <input type="checkbox" [(ngModel)]="showOutGuide" (change)="onOutGuideToggle()"> 終了位置ガイドを表示 (赤)
                    </label>
                  </div>

                  <div class="flex-row">
                    <div class="flex-label">時間(ms)</div>
                    <div class="flex-controls">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.outDuration" (change)="onOutDetailChange()" step="100" min="0">
                      <select class="udonarium-select" [(ngModel)]="editingCutIn.outEasing" (change)="onOutDetailChange()">
                        <option *ngFor="let e of easings" [value]="e">{{e}}</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">位置 X</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="-100" max="200" step="1" [(ngModel)]="editingCutIn.endLeft" (input)="onOutDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.endLeft" (change)="onOutDetailChange()">
                      <span class="unit-text">%</span>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">位置 Y</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="-100" max="200" step="1" [(ngModel)]="editingCutIn.endTop" (input)="onOutDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.endTop" (change)="onOutDetailChange()">
                      <span class="unit-text">%</span>
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">不透明度</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="0" max="1" step="0.1" [(ngModel)]="editingCutIn.endOpacity" (input)="onOutDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.endOpacity" (change)="onOutDetailChange()" step="0.1" min="0" max="1">
                    </div>
                  </div>
                  <div class="flex-row">
                    <div class="flex-label">拡大率</div>
                    <div class="flex-controls">
                      <input type="range" style="flex: 1" min="0.1" max="3.0" step="0.1" [(ngModel)]="editingCutIn.endScale" (input)="onOutDetailChange()">
                      <input type="number" class="udonarium-input width-short" [(ngModel)]="editingCutIn.endScale" (change)="onOutDetailChange()" step="0.1" min="0.1" max="3.0">
                      <span class="unit-text">倍</span>
                    </div>
                  </div>
                </details>
              </div>
            </div>
          </div>

        </div>
      </ng-container>

      <ng-template #noSelection>
        <div class="empty-state">
          <i class="material-icons empty-state-icon">auto_fix_high</i>
          <div class="empty-state-message">カットインを選択するか、新規作成してください</div>
          <div class="empty-state-description">
            画像や動画、音響によるダイナミックな演出を画面上に表示します
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>