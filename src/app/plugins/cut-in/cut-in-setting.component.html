<div class="layout-container">
  <div class="layout-body">
    <!-- 左カラム: リスト -->
    <div class="left-panel">
      <div class="panel-header">
        <button class="btn btn-xs btn-primary full-width-btn" (click)="createNew()">＋ 新規追加</button>
      </div>
      <div class="custom-list flex-grow-1">
        <button *ngFor="let item of cutIns" 
                class="custom-list-item"
                [class.active]="selectedIdentifier === item.identifier"
                (click)="select(item.identifier)">
          {{ item.name || '(名称未設定)' }}
        </button>
        <div *ngIf="cutIns.length === 0" class="empty-message">
          データがありません
        </div>
      </div>
    </div>

    <!-- 右カラム: 編集・実行 -->
    <div class="right-panel">
      <ng-container *ngIf="editingCutIn; else noSelection">
        <div class="header-row">
          <h6 class="title">
            <span class="badge badge-secondary mr-1">{{ editingCutIn.identifier ? '編集' : '新規' }}</span>
            {{ editingCutIn.name }}
          </h6>
          <div class="btn-group">
            <button class="btn btn-sm btn-success" (click)="play()" title="全体に再生">▶ 再生</button>
            <button class="btn btn-sm btn-info" (click)="playLocal()" title="自分だけ見る">👁</button>
          </div>
        </div>

        <!-- タイプ選択 -->
        <div class="form-group">
          <div class="radio-group">
            <input type="radio" id="typeImage" name="cutInType" value="image" [(ngModel)]="cutInType">
            <label for="typeImage">画像 (Image)</label>
            
            <input type="radio" id="typeVideo" name="cutInType" value="video" [(ngModel)]="cutInType">
            <label for="typeVideo">動画 (YouTube)</label>
          </div>
        </div>

        <!-- プレビュー (画像) -->
        <div *ngIf="cutInType === 'image'" class="preview-area" (click)="openImageSelecter()" title="画像を変更">
          <img [src]="getImageUrl(editingCutIn.imageIdentifier)" class="img-fluid" *ngIf="editingCutIn.imageIdentifier">
          <div class="preview-placeholder" *ngIf="!editingCutIn.imageIdentifier">クリックして画像を選択</div>
        </div>

        <!-- プレビュー (動画) -->
        <div *ngIf="cutInType === 'video'" class="preview-area">
          <img [src]="getVideoThumbnailUrl()" class="img-fluid" *ngIf="editingCutIn.videoIdentifier">
          <div class="preview-placeholder" *ngIf="!editingCutIn.videoIdentifier">URLを入力してください</div>
        </div>

        <!-- 編集フォーム -->
        <div class="form-section">
          <div class="flex-row" *ngIf="cutInType === 'video'">
            <div class="flex-label small">URL</div>
            <div class="flex-controls column-direction">
              <input type="text" class="form-control" [(ngModel)]="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
              <div class="text-right">
                <a href="https://www.youtube.com/terms" target="_blank" class="small-link">YouTube 利用規約</a>
              </div>
            </div>
          </div>
          
          <div class="flex-row">
            <div class="flex-label small">名前</div>
            <div class="flex-controls">
              <input type="text" class="form-control" [(ngModel)]="editingCutIn.name">
            </div>
          </div>
          
          <div class="flex-row">
            <div class="flex-label small">秒数</div>
            <div class="flex-controls">
              <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.duration" min="0">
              <span class="small-label ml-1" style="margin-left: 4px;">(0=無制限)</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="small-label">起動キーワード</label>
          <input type="text" class="form-control bold-text" [(ngModel)]="editingCutIn.keyword" placeholder="@必殺技 など">
        </div>

        <div class="section-divider">音声設定</div>
        <div class="form-group">
          <label class="small-label">音源</label>
          <select class="form-control" [(ngModel)]="editingCutIn.audioIdentifier">
            <option value="">(なし)</option>
            <option *ngFor="let audio of audios" [value]="audio.identifier">{{ audio.name }}</option>
          </select>
        </div>

        <div class="form-group" *ngIf="editingCutIn.audioIdentifier">
          <div class="radio-group mb-1">
            <input type="radio" id="audioModeSE" name="audioMode" value="se" [(ngModel)]="editingCutIn.audioMode">
            <label for="audioModeSE">SEとして再生</label>
            
            <input type="radio" id="audioModeBGM" name="audioMode" value="bgm" [(ngModel)]="editingCutIn.audioMode">
            <label for="audioModeBGM">BGMとして再生</label>
          </div>

          <div class="checkbox-row small">
            <label *ngIf="editingCutIn.audioMode === 'se'" class="mr-3">
              <input type="checkbox" [(ngModel)]="editingCutIn.isLoop"> ループ再生
            </label>
            <label>
              <input type="checkbox" [(ngModel)]="editingCutIn.stopJukebox"> 既存BGMを停止
            </label>
          </div>
        </div>

        <div class="section-divider">大きさ</div>
        <div class="form-group">
          <div class="radio-group mb-1">
            <input type="radio" id="modeScale" name="sizeMode" value="scale" [(ngModel)]="sizeMode">
            <label for="modeScale">拡大率で指定</label>
            
            <input type="radio" id="modeRatio" name="sizeMode" value="ratio" [(ngModel)]="sizeMode">
            <label for="modeRatio">比率で指定</label>
          </div>

          <div *ngIf="sizeMode === 'scale'" class="flex-row align-items-center mb-1">
            <div class="flex-label small">拡大率</div>
            <div class="flex-controls">
              <input type="range" class="custom-range flex-grow-1 mr-2" min="0.1" max="3.0" step="0.1" [(ngModel)]="editingCutIn.scale">
              <div class="input-with-unit">
                <input type="number" class="form-control" [(ngModel)]="editingCutIn.scale" min="0.1" step="0.1">
                <span class="unit-text">倍</span>
              </div>
            </div>
          </div>

          <div *ngIf="sizeMode === 'ratio'" class="flex-row align-items-center mb-1">
            <div class="flex-label small">幅(%)</div>
            <div class="flex-controls">
              <input type="range" class="custom-range flex-grow-1 mr-2" min="1" max="100" step="1" [(ngModel)]="editingCutIn.width">
              <div class="input-with-unit">
                <input type="number" class="form-control" [(ngModel)]="editingCutIn.width" min="1" max="100">
                <span class="unit-text">%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="section-divider">表示位置</div>
        <div class="form-group">
          <div class="flex-row align-items-center mb-1">
            <div class="flex-label small">X (%)</div>
            <div class="flex-controls">
              <input type="range" class="custom-range flex-grow-1 mr-2" min="0" max="100" step="1" [(ngModel)]="editingCutIn.left">
              <div class="input-with-unit no-unit">
                <input type="number" class="form-control" [(ngModel)]="editingCutIn.left" min="0" max="100">
              </div>
            </div>
          </div>
          <div class="flex-row align-items-center mb-1">
            <div class="flex-label small">Y (%)</div>
            <div class="flex-controls">
              <input type="range" class="custom-range flex-grow-1 mr-2" min="0" max="100" step="1" [(ngModel)]="editingCutIn.top">
              <div class="input-with-unit no-unit">
                <input type="number" class="form-control" [(ngModel)]="editingCutIn.top" min="0" max="100">
              </div>
            </div>
          </div>
          <div class="flex-row align-items-center">
            <div class="flex-label small">不透明度</div>
            <div class="flex-controls">
              <input type="range" class="custom-range flex-grow-1 mr-2" min="0" max="1" step="0.1" [(ngModel)]="editingCutIn.opacity">
              <div class="input-with-unit no-unit">
                <input type="number" class="form-control" [(ngModel)]="editingCutIn.opacity" min="0" max="1" step="0.1">
              </div>
            </div>
          </div>
        </div>

        <div class="section-divider">演出（登場時）</div>
        <div class="form-group">
          <label class="small-label">クイック設定</label>
          <div class="quick-btns">
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('fade')">フェード</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('slide-left')">←スライド</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('slide-right')">スライド→</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('slide-up')">↑スライド</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('slide-down')">↓スライド</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('zoom-in')">ズームイン</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickInEffect('zoom-out')">ズームアウト</button>
          </div>
        </div>

        <div class="form-group">
          <div class="flex-row mb-1 align-items-center">
            <div class="flex-label small">時間(ms)</div>
            <div class="flex-controls">
              <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.inDuration" step="100" min="0">
              <select class="form-control flex-grow-1 ml-1" [(ngModel)]="editingCutIn.easing">
                <option *ngFor="let e of easings" [value]="e">{{e}}</option>
              </select>
            </div>
          </div>
          
          <details class="advanced-settings">
            <summary class="small">開始状態の詳細設定</summary>
            <div class="flex-row align-items-center mb-1">
              <div class="flex-label small">開始X (%)</div>
              <div class="flex-controls">
                <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.startLeft">
                <span class="small-label ml-2">開始Y (%)</span>
                <input type="number" class="form-control width-short ml-1" [(ngModel)]="editingCutIn.startTop">
              </div>
            </div>
            <div class="flex-row align-items-center mb-1">
              <div class="flex-label small">不透明度</div>
              <div class="flex-controls">
                <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.startOpacity" step="0.1" min="0" max="1">
                <span class="small-label ml-2">スケール</span>
                <input type="number" class="form-control width-short ml-1" [(ngModel)]="editingCutIn.startScale" step="0.1">
              </div>
            </div>
          </details>
        </div>

        <div class="section-divider">演出（退場時）</div>
        <div class="form-group">
          <label class="small-label">クイック設定</label>
          <div class="quick-btns">
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('fade')">フェードアウト</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('slide-left')">←スライド消去</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('slide-right')">スライド消去→</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('slide-up')">↑スライド消去</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('slide-down')">↓スライド消去</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('zoom-in')">ズームアウト(拡大)</button>
            <button class="btn btn-xs btn-outline-primary" (click)="setQuickOutEffect('zoom-out')">ズームアウト(縮小)</button>
          </div>
        </div>

        <div class="form-group">
          <div class="flex-row mb-1 align-items-center">
            <div class="flex-label small">時間(ms)</div>
            <div class="flex-controls">
              <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.outDuration" step="100" min="0">
              <select class="form-control flex-grow-1 ml-1" [(ngModel)]="editingCutIn.outEasing">
                <option *ngFor="let e of easings" [value]="e">{{e}}</option>
              </select>
            </div>
          </div>
          
          <details class="advanced-settings">
            <summary class="small">終了状態の詳細設定</summary>
            <div class="flex-row align-items-center mb-1">
              <div class="flex-label small">終了X (%)</div>
              <div class="flex-controls">
                <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.endLeft">
                <span class="small-label ml-2">終了Y (%)</span>
                <input type="number" class="form-control width-short ml-1" [(ngModel)]="editingCutIn.endTop">
              </div>
            </div>
            <div class="flex-row align-items-center mb-1">
              <div class="flex-label small">不透明度</div>
              <div class="flex-controls">
                <input type="number" class="form-control width-short" [(ngModel)]="editingCutIn.endOpacity" step="0.1" min="0" max="1">
                <span class="small-label ml-2">スケール</span>
                <input type="number" class="form-control width-short ml-1" [(ngModel)]="editingCutIn.endScale" step="0.1">
              </div>
            </div>
          </details>
        </div>

        <div class="footer-actions">
          <button class="btn btn-sm btn-outline-danger" (click)="delete()">削除</button>
          <button class="btn btn-sm btn-primary px-4" (click)="save()">保存</button>
        </div>
      </ng-container>

      <ng-template #noSelection>
        <div class="empty-state">
          <i class="material-icons large-icon">touch_app</i>
          <p>項目を選択するか、新規作成してください</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>