<div class="table" [ngClass]="{ 'direct-message': isDirect }">
  <div class="table-cell imagebox">
    <img *ngIf="0 < imageFile.url.length" class="image" [src]="imageFile.url | safe: 'resourceUrl'" />
  </div>
  <div class="table-cell">
    <div>
      <!-- ----- MODIFICATION START (kunyatta) for ColorSupport ----- -->
      <input *ngIf="showColorPicker" type="color" [(ngModel)]="sendFromColor" class="color-picker" />
      <!-- ----- MODIFICATION END (kunyatta) for ColorSupport ----- -->
      <!-- ----- MODIFICATION START (kunyatta) for CSS Separation ----- -->
      <!-- <select style="width: 12em;" [(ngModel)]="sendFrom"> -->
      <select class="select-send-from" [(ngModel)]="sendFrom">
      <!-- ----- MODIFICATION END (kunyatta) for CSS Separation ----- -->
        <option *ngIf="!onlyCharacters" value="{{myPeer?.identifier}}">{{myPeer?.name}}（あなた）</option>
        <option *ngFor="let gameCharacter of gameCharacters" value="{{gameCharacter.identifier}}">{{gameCharacter.name}}
        </option>
      </select> ＞
      <!-- ----- MODIFICATION START (kunyatta) for CSS Separation ----- -->
      <!-- <select style="width: 10em;" [(ngModel)]="sendTo"> -->
      <select class="select-send-to" [(ngModel)]="sendTo">
      <!-- ----- MODIFICATION END (kunyatta) for CSS Separation ----- -->
        <option value="">全員</option>
        <option *ngFor="let peer of otherPeers" value="{{peer.identifier}}">{{peer.name}}
          <ng-container *ngIf="peer === myPeer">（あなた）</ng-container>
        </option>
      </select>
      <ng-container *ngIf="0 < diceBotInfos.length">
        <!-- ----- MODIFICATION START (kunyatta) for CSS Separation ----- -->
        <!-- <select #select style="width: 12em;" (change)="loadDiceBot(select.value)" [(ngModel)]="gameType" -->
        <select #select class="select-dice-bot" (change)="loadDiceBot(select.value)" [(ngModel)]="gameType"
          [ngModelOptions]="{standalone: true}">
        <!-- ----- MODIFICATION END (kunyatta) for CSS Separation ----- -->
          <!-- ----- MODIFICATION START (kunyatta) for PluginSystem ----- -->
          <!-- <option *ngFor="let diceBotInfo of diceBotInfos" value="{{diceBotInfo.id}}">{{diceBotInfo.name}}</option> -->
          <option *ngFor="let diceBotInfo of diceBotInfos" value="{{diceBotInfo.id}}">{{diceBotInfo.name === "DiceBot" ? "ダイスボット指定なし" : diceBotInfo.name}}</option>
          <!-- ----- MODIFICATION END (kunyatta) for PluginSystem ----- -->
        </select>
      </ng-container>
      <ng-container *ngIf="diceBotInfos.length < 1">
        <!-- ----- MODIFICATION START (kunyatta) for CSS Separation ----- -->
        <!-- <select style="width: 12em;" disabled> -->
        <select class="select-dice-bot" disabled>
        <!-- ----- MODIFICATION END (kunyatta) for CSS Separation ----- -->
          <option value="">ダイスボット読込中...</option>
        </select>
      </ng-container>
      <button (click)="showDicebotHelp()" [disabled]="diceBotInfos.length < 1">?</button>
    </div>
    <!-- ----- MODIFICATION START (kunyatta) for DynamicStandPlugin ----- -->
    <div *ngIf="showColorPicker && onlyCharacters" class="extension-button-row" style="margin: 4px 0; display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
      <button *ngFor="let extension of chatInputExtensions" (click)="extension.action({ character: $any(ObjectStore.instance.get(sendFrom)), component: this }, { x: $event.clientX, y: $event.clientY }); $event.stopPropagation()" 
        style="font-size: 0.75rem; padding: 2px 6px; display: inline-flex; align-items: center; gap: 2px; height: 24px; vertical-align: middle;"
        [title]="getExtensionDescription(extension)"> <!-- ----- MODIFICATION (Gemini) for TargetSelectorPlugin ----- -->
        <!-- ----- MODIFICATION START (kunyatta) for MaterialSymbolsSupport ----- -->
        <!-- <i *ngIf="extension.icon" class="material-icons" style="font-size: 1rem;">{{getExtensionIcon(extension)}}</i> -->
        <i *ngIf="extension.icon" [ngClass]="extension.iconClass || 'material-icons'" style="font-size: 1rem;">{{getExtensionIcon(extension)}}</i>
        <!-- ----- MODIFICATION END (kunyatta) ----- -->
        <span>{{getExtensionLabel(extension)}}</span> <!-- ----- MODIFICATION (Gemini) for TargetSelectorPlugin ----- -->
      </button>

      <!-- クイックアクション用（アイコンのみ・枠なし） -->
      <button *ngFor="let quick of chatInputQuickExtensions" (click)="quick.action({ character: $any(ObjectStore.instance.get(sendFrom)), component: this }); $event.stopPropagation()"
        [title]="getExtensionDescription(quick) || getExtensionLabel(quick)"
        style="background: transparent; border: none; padding: 0 4px; cursor: pointer; font-size: 1.2rem; min-width: 28px; height: 24px; display: inline-flex; align-items: center; justify-content: center; opacity: 0.8;"
        [style.color]="getExtensionColor(quick) || 'white'">
        <i style="font-style: normal;">{{ getExtensionIcon(quick) }}</i>
        <span *ngIf="!quick.icon">{{ getExtensionLabel(quick) }}</span>
      </button>
    </div>
    <!-- ----- MODIFICATION START (kunyatta) for Dynamic UI Slot ----- -->
    <div *ngIf="showColorPicker && onlyCharacters && uiExtensionService.activeComponent && uiExtensionService.activeContext?.component === this" class="extension-custom-slot" (click)="$event.stopPropagation()">
      <ng-container *ngComponentOutlet="uiExtensionService.activeComponent"></ng-container>
    </div>
    <!-- ----- MODIFICATION END (kunyatta) for Dynamic UI Slot ----- -->
    <!-- ----- MODIFICATION END (kunyatta) for DynamicStandPlugin ----- -->
    <div>
      <form>
        <!-- ----- MODIFICATION START (kunyatta) for ChatHistory ----- -->
        <!-- <textarea class="chat-input" placeholder="Enterで送信  Shift+Enterで改行" [(ngModel)]="text"
          [ngModelOptions]="{standalone: true}" (input)="onInput()" (keydown.enter)="sendChat($event)"
          (keydown.control.arrowup)="moveHistory($event, 1)" (keydown.control.arrowdown)="moveHistory($event, -1)"
          #textArea></textarea> -->
        <textarea class="chat-input" placeholder="Enterで送信  Shift+Enterで改行　Ctrl+↑↓で履歴" [(ngModel)]="text"
          [ngModelOptions]="{standalone: true}" (input)="onInput()" (keydown.enter)="sendChat($event)"
          (keydown.control.arrowup)="moveHistory($event, 1)" (keydown.control.arrowdown)="moveHistory($event, -1)"
          #textArea></textarea>
        <!-- ----- MODIFICATION END (kunyatta) for ChatHistory ----- -->
        <button type="submit" (click)="sendChat(null)">SEND</button>
      </form>
    </div>
    <div class="writing-info">
      <ng-container *ngIf="0 < writingPeerNames.length">
        <span *ngFor="let peerName of writingPeerNames; index as i" style="font-weight: bold;">{{peerName}}<span
            *ngIf="writingPeerNames.length !== (i + 1)">, </span></span>
        <span> が入力中...</span>
      </ng-container>
    </div>
  </div>
</div>
